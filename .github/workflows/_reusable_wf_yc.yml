name: Reusable Yandex Cloud Function Deployment

on:
  workflow_call:
    inputs:
      function-name:
        required: true
        type: string
      local-name:
        required: true
        type: string
      memory:
        required: true
        type: string
      # TODO timeout
    

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: make requirements
        run: 	cp src/${{ inputs.local-name }}/requirements.txt src/requirements.txt

      - name: Deploy to Yandex Cloud Function
        uses: yc-actions/yc-sls-function@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          # bucket: ${{ secrets.YC_S3_BUCKET_NAME }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          runtime: 'python312'

          function-name: ${{ inputs.function-name }}
          memory: ${{ inputs.memory }}
          entrypoint: ${{ inputs.local-name }}.main.main
          source-root: src
          execution-timeout: 60 # TODO parametrize
          include: |
            ${{ inputs.local-name }}
            _dependencies
            requirements.txt
          environment: |
            POSTGRES_HOST=${{ secrets.YC_POSTGRES_HOST }}
            POSTGRES_PORT=${{ secrets.YC_POSTGRES_PORT }}
            POSTGRES_DB=${{ secrets.YC_POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.YC_POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.YC_POSTGRES_PASSWORD }}
            BOT_API_TOKEN__PROD=${{ secrets.YC_BOT_API_TOKEN__PROD }}
            BOT_API_TOKEN=${{ secrets.YC_BOT_API_TOKEN }}
            MY_TELEGRAM_ID=${{ secrets.YC_MY_TELEGRAM_ID }}
            FORUM_BOT_LOGIN=${{ secrets.YC_FORUM_BOT_LOGIN }}
            FORUM_BOT_PASSWORD=${{ secrets.YC_FORUM_BOT_PASSWORD }}
            OSM_IDENTIFIER=${{ secrets.YC_OSM_IDENTIFIER }}
            YANDEX_API_KEY=${{ secrets.YC_YANDEX_API_KEY }}
            WEB_APP_URL_TEST=${{ secrets.YC_WEB_APP_URL_TEST }}
            WEB_APP_URL=${{ secrets.YC_WEB_APP_URL }}
            AWS_ACCESS_KEY_ID=${{ secrets.YC_AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.YC_AWS_SECRET_ACCESS_KEY }}
